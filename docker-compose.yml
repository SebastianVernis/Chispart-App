version: '3.8'

services:
  blackbox-hybrid-tool:
    build:
      context: .
      dockerfile: Dockerfile
    container_name: ${APP_SLUG:-blackbox-hybrid-tool}
    ports:
      - "${PORT:-8005}:8000"
    volumes:
      # Solo montar directorios necesarios para evitar problemas de permisos
      - ./logs:/app/logs
      - ./config:/app/config
      - ./static:/app/static
      - ./frontend:/app/frontend
    environment:
      - LOG_LEVEL=${LOG_LEVEL:-INFO}
      - CONFIG_FILE=config/models.json
      - PYTHONPATH=/app
      - APP_NAME=${APP_NAME:-Chispart AI}
      - APP_TAGLINE=${APP_TAGLINE:-Plataforma de IA multiagente}
      - APP_VERSION=${APP_VERSION:-1.0.0}
      - WRITE_ROOT=/app
      - AUTO_SNAPSHOT=${AUTO_SNAPSHOT:-false}
      - PORT=8000
    env_file:
      - .env
    command: ["python", "main.py"]
    restart: unless-stopped
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8000/health"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 40s
    networks:
      - chispart-network

  # Servicio opcional para desarrollo con hot reload
  dev:
    build:
      context: .
      dockerfile: Dockerfile
    container_name: ${APP_SLUG:-blackbox-hybrid-tool}-dev
    ports:
      - "${DEV_PORT:-8006}:8000"
    volumes:
      # En desarrollo, montar todo el c√≥digo para hot reload
      - .:/app
      - ./logs:/app/logs
    environment:
      - LOG_LEVEL=DEBUG
      - CONFIG_FILE=config/models.json
      - PYTHONPATH=/app
      - APP_NAME=${APP_NAME:-Chispart AI Dev}
      - APP_TAGLINE=${APP_TAGLINE:-Plataforma de IA multiagente (Dev)}
      - APP_VERSION=${APP_VERSION:-1.0.0-dev}
      - WRITE_ROOT=/app
      - AUTO_SNAPSHOT=false
      - PORT=8000
    env_file:
      - .env
    command: ["uvicorn", "main:app", "--host", "0.0.0.0", "--port", "8000", "--reload"]
    profiles:
      - dev
    networks:
      - chispart-network

networks:
  chispart-network:
    driver: bridge
